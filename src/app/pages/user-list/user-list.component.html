<div class="user-list-container">
    <div class="header-section">
        <div class="header-title">
            <h1>User Management</h1>
            <p class="text-secondary hide-mobile">Browse and manage registered users.</p>
        </div>
        <div class="header-actions">
            <div class="search-container">
                <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input type="text" pInputText placeholder="Search..." [(ngModel)]="searchQuery"
                        (input)="onSearch()" class="p-inputtext-sm search-input" />
                </span>
            </div>
        </div>
    </div>

    <div class="table-section">
        <p-card>
            <div class="table-wrapper">
                <p-table [value]="users" [lazy]="true" (onLazyLoad)="onPageChange($event)" [paginator]="true" [rows]="rows"
                    [totalRecords]="totalRecords" [loading]="loading" [showCurrentPageReport]="true"
                    styleClass="p-datatable-striped p-datatable-sm" [responsive]="true"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords}">

                    <ng-template pTemplate="header">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th class="hide-mobile">Role</th>
                            <th class="hide-mobile">Joined</th>
                            <th style="width: 80px">Actions</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-user>
                        <tr>
                            <td>
                                <div class="user-name-cell">
                                    <span class="user-name font-bold"
                                          [pTooltip]="user.name"
                                          tooltipPosition="top"
                                          [tooltipDisabled]="user.name?.length < 20">{{user.name}}</span>
                                    <span class="user-role-mobile show-mobile">
                                        <p-tag [value]="user.role" [severity]="user.role === 'ADMIN' ? 'danger' : 'info'"
                                               styleClass="role-tag-sm"></p-tag>
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span class="user-email"
                                      [pTooltip]="user.email"
                                      tooltipPosition="top"
                                      [tooltipDisabled]="user.email?.length < 20">{{user.email}}</span>
                            </td>
                            <td class="hide-mobile">
                                <p-tag [value]="user.role" [severity]="user.role === 'ADMIN' ? 'danger' : 'info'"></p-tag>
                            </td>
                            <td class="hide-mobile">{{user.createdAt | date:'shortDate'}}</td>
                            <td>
                                <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text p-button-sm"
                                    (click)="showDetails(user)" pTooltip="View Details"></button>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="5" class="text-center p-4">No users found.</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </p-card>
    </div>
</div>

<p-dialog [(visible)]="userDialog" [style]="{width: '550px'}" header="User Details" [modal]="true" class="p-fluid">
    <ng-template pTemplate="content">
        <div class="user-details-grid">
            <!-- User Photo -->
            <div class="detail-item mb-3 text-center" *ngIf="selectedUser.photoUrl">
                <img [src]="selectedUser.photoUrl" alt="User Photo" class="user-photo-large" />
            </div>

            <div class="detail-item mb-3">
                <label class="block text-secondary text-sm mb-1">User ID</label>
                <div class="font-medium p-2 bg-gray-100 border-round text-sm">{{selectedUser.id}}</div>
            </div>
            <div class="detail-item mb-3">
                <label class="block text-secondary text-sm mb-1">Cognito ID</label>
                <div class="font-medium p-2 bg-gray-100 border-round text-sm">{{selectedUser.cognitoUserId}}</div>
            </div>
            <div class="detail-item mb-3">
                <label class="block text-secondary text-sm mb-1">Full Name</label>
                <div class="font-medium text-lg">{{selectedUser.name || '-'}}</div>
            </div>
            <div class="detail-item mb-3">
                <label class="block text-secondary text-sm mb-1">Email Address</label>
                <div class="font-medium">{{selectedUser.email || '-'}}</div>
            </div>

            <!-- Birthday -->
            <div class="detail-item mb-3">
                <label class="block text-secondary text-sm mb-1">
                    <i class="pi pi-calendar mr-1"></i> Birthday
                </label>
                <div class="font-medium">
                    <span *ngIf="selectedUser.birthDate">{{selectedUser.birthDate | date:'mediumDate'}}</span>
                    <span *ngIf="!selectedUser.birthDate" class="text-secondary">Not provided</span>
                </div>
            </div>

            <!-- Location -->
            <div class="detail-item mb-3">
                <label class="block text-secondary text-sm mb-1">
                    <i class="pi pi-map-marker mr-1"></i> Location
                </label>
                <div class="font-medium">
                    <div *ngIf="selectedUser.latitude && selectedUser.longitude" class="location-info">
                        <span class="location-coords">
                            Lat: {{selectedUser.latitude | number:'1.4-4'}},
                            Lng: {{selectedUser.longitude | number:'1.4-4'}}
                        </span>
                        <a [href]="'https://www.google.com/maps?q=' + selectedUser.latitude + ',' + selectedUser.longitude"
                           target="_blank" class="map-link ml-2" pTooltip="View on Google Maps">
                            <i class="pi pi-external-link"></i>
                        </a>
                    </div>
                    <span *ngIf="!selectedUser.latitude || !selectedUser.longitude" class="text-secondary">Not provided</span>
                </div>
            </div>

            <div class="detail-item mb-3">
                <label class="block text-secondary text-sm mb-1">Role</label>
                <div class="flex align-items-center gap-2">
                    <p-dropdown [options]="roleOptions" [(ngModel)]="selectedUser.role"
                        [disabled]="updatingRole"
                        styleClass="w-full md:w-10rem">
                    </p-dropdown>
                    <i *ngIf="updatingRole" class="pi pi-spin pi-spinner"></i>
                </div>
                <small class="block mt-1 text-secondary">Select a role and click Save to update. Changes apply to both database and Cognito.</small>
            </div>
            <div class="detail-item">
                <label class="block text-secondary text-sm mb-1">Joined Date</label>
                <div class="font-medium">{{selectedUser.createdAt | date:'medium'}}</div>
            </div>
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <button pButton label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideDialog()" [disabled]="updatingRole"></button>
        <button pButton label="Save" icon="pi pi-check" class="p-button-primary" (click)="saveUserRole()"
            [disabled]="!hasRoleChanged() || updatingRole" [loading]="updatingRole"></button>
    </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
