<div class="dashboard-container">
  <!-- Stats Summary Cards -->
  <div class="stats-grid">
    <div class="stat-card dau-card">
      <div class="stat-icon">
        <i class="pi pi-users"></i>
      </div>
      <div class="stat-content">
        <span class="stat-label">Daily Active Users</span>
        <span class="stat-value">{{ totalDAU | number }}</span>
        <span class="stat-trend positive">
          <i class="pi pi-arrow-up"></i>
          {{ dauGrowth }}% vs yesterday
        </span>
      </div>
    </div>

    <div class="stat-card mau-card">
      <div class="stat-icon">
        <i class="pi pi-chart-line"></i>
      </div>
      <div class="stat-content">
        <span class="stat-label">Monthly Active Users</span>
        <span class="stat-value">{{ totalMAU | number }}</span>
        <span class="stat-trend positive">
          <i class="pi pi-arrow-up"></i>
          {{ mauGrowth }}% vs last month
        </span>
      </div>
    </div>

    <div class="stat-card retention-card">
      <div class="stat-icon">
        <i class="pi pi-heart"></i>
      </div>
      <div class="stat-content">
        <span class="stat-label">Retention Rate</span>
        <span class="stat-value">{{ retentionRate | number:'1.1-1' }}%</span>
        <span class="stat-trend positive">
          <i class="pi pi-info-circle"></i>
          30-day active retention
        </span>
      </div>
    </div>

    <div class="stat-card avg-card">
      <div class="stat-icon">
        <i class="pi pi-clock"></i>
      </div>
      <div class="stat-content">
        <span class="stat-label">Avg. Engagement</span>
        <span class="stat-value">{{ avgSessionMinutes | number:'1.1-1' }} min</span>
        <span class="stat-trend positive">
          <i class="pi pi-info-circle"></i>
          Daily per user
        </span>
      </div>
    </div>

    <div class="stat-card cost-card">
      <div class="stat-icon">
        <i class="pi pi-dollar"></i>
      </div>
      <div class="stat-content">
        <span class="stat-label">AWS Monthly Cost</span>
        <span class="stat-value">{{ serverCost }} {{ costUnit }}</span>
        <span class="stat-trend">
          <i class="pi pi-calendar"></i>
          Estimate for {{ currentMonth }}
        </span>
      </div>
    </div>
  </div>

  <!-- Charts Grid -->
  <div class="charts-grid">
    <!-- DAU Chart -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <i class="pi pi-chart-bar"></i>
          <span>Daily Active Users</span>
        </div>
        <span class="chart-subtitle">Last 14 days</span>
      </div>
      <div class="chart-container">
        <p-chart type="line" [data]="dauChartData" [options]="dauChartOptions" [height]="'100%'"></p-chart>
      </div>
    </div>

    <!-- MAU Chart -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <i class="pi pi-chart-line"></i>
          <span>Monthly Active Users</span>
        </div>
        <span class="chart-subtitle">Last 12 months</span>
      </div>
      <div class="chart-container">
        <p-chart type="line" [data]="mauChartData" [options]="mauChartOptions" [height]="'100%'"></p-chart>
      </div>
    </div>
  </div>

  <!-- Trending Media Section -->
  <div class="trending-section mt-4">
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <i class="pi pi-bolt"></i>
          <span>Top Performing Media</span>
        </div>
        <span class="chart-subtitle">Real-time trending based on play counts</span>
      </div>
      <div class="p-4">
        <p-table [value]="trendingMedia" styleClass="p-datatable-sm" [responsive]="true">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 80px">Rank</th>
              <th>Media Title</th>
              <th>Type</th>
              <th style="width: 150px">Total Plays</th>
              <th style="width: 200px">Last Updated</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>
                <span class="rank-badge" [class.top-3]="item.rank <= 3">
                  {{item.rank}}
                </span>
              </td>
              <td>
                <div class="flex align-items-center gap-2">
                  <span class="font-bold">{{item.media.title}}</span>
                </div>
              </td>
              <td>
                <p-tag [value]="item.media.mediaType"
                  [severity]="item.media.mediaType === 'VIDEO' ? 'primary' : 'success'"></p-tag>
              </td>
              <td class="font-medium">{{item.playCount | number}}</td>
              <td class="text-secondary text-sm">{{item.updatedAt | date:'medium'}}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center p-4">No trending data available yet.</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>

  <!-- CI/CD Pipeline Status Section -->
  <div class="pipeline-section mt-4">
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <i class="pi pi-sitemap"></i>
          <span>CI/CD Pipeline Status</span>
        </div>
        <span class="chart-subtitle">Real-time deployment status</span>
        <button pButton icon="pi pi-refresh" class="p-button-text p-button-sm ml-auto"
          (click)="loadPipelineStatuses()" [loading]="pipelinesLoading"></button>
      </div>
      <div class="p-4">
        <div *ngIf="pipelinesLoading" class="flex justify-content-center p-4">
          <p-progressSpinner [style]="{width: '40px', height: '40px'}"></p-progressSpinner>
        </div>
        <div *ngIf="!pipelinesLoading && pipelines.length === 0" class="text-center p-4 text-secondary">
          No pipelines found.
        </div>
        <div *ngIf="!pipelinesLoading && pipelines.length > 0" class="pipeline-grid">
          <div *ngFor="let pipeline of pipelines" class="pipeline-card p-3 border-round surface-ground mb-2">
            <div class="flex align-items-center justify-content-between mb-2">
              <div class="flex align-items-center gap-2">
                <i [class]="getPipelineIcon(pipeline.status)"
                   [ngClass]="{
                     'text-green-500': pipeline.status === 'Succeeded',
                     'text-yellow-500': pipeline.status === 'InProgress',
                     'text-red-500': pipeline.status === 'Failed'
                   }"></i>
                <span class="font-bold">{{ pipeline.pipelineName }}</span>
              </div>
              <p-tag [value]="pipeline.status" [severity]="getPipelineStatusSeverity(pipeline.status)"></p-tag>
            </div>
            <div *ngIf="pipeline.stages && pipeline.stages.length > 0" class="stages-container">
              <div class="flex gap-1 align-items-center">
                <ng-container *ngFor="let stage of pipeline.stages; let last = last">
                  <div class="stage-indicator flex align-items-center gap-1 px-2 py-1 border-round text-xs"
                       [ngClass]="{
                         'bg-green-100 text-green-700': stage.status === 'Succeeded',
                         'bg-yellow-100 text-yellow-700': stage.status === 'InProgress',
                         'bg-red-100 text-red-700': stage.status === 'Failed',
                         'bg-gray-100 text-gray-500': stage.status === 'NotStarted'
                       }">
                    <i class="pi text-xs"
                       [ngClass]="{
                         'pi-check': stage.status === 'Succeeded',
                         'pi-spin pi-spinner': stage.status === 'InProgress',
                         'pi-times': stage.status === 'Failed',
                         'pi-circle': stage.status === 'NotStarted'
                       }"></i>
                    {{ stage.stageName }}
                  </div>
                  <i *ngIf="!last" class="pi pi-arrow-right text-gray-400 text-xs"></i>
                </ng-container>
              </div>
            </div>
            <div *ngIf="pipeline.updatedAt" class="text-xs text-secondary mt-2">
              Last updated: {{ pipeline.updatedAt | date:'medium' }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
