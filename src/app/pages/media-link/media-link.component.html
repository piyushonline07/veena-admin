<div class="media-link-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1><i class="pi pi-link"></i> Link Audio & Video</h1>
      <p class="subtitle">Connect audio tracks with their corresponding video versions</p>
    </div>
    <div class="header-stats">
      <div class="stat-badge">
        <i class="pi pi-check-circle"></i>
        <span>{{getLinkedCount()}} Linked</span>
      </div>
      <div class="stat-badge warning">
        <i class="pi pi-exclamation-circle"></i>
        <span>{{getUnlinkedAudioCount()}} Unlinked Audio</span>
      </div>
    </div>
  </div>

  <!-- Main Content - Two Panel Layout -->
  <div class="link-content">
    <!-- Left Panel - Audio List -->
    <div class="media-panel audio-panel">
      <div class="panel-header">
        <h3><i class="pi pi-volume-up"></i> Audio Tracks</h3>
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText [(ngModel)]="audioSearchQuery" (ngModelChange)="onAudioSearch()"
                 placeholder="Search audio..." class="search-input" />
        </span>
      </div>

      <div class="media-list" *ngIf="!isLoadingAudio">
        <div *ngFor="let audio of filteredAudioList"
             class="media-card"
             [class.selected]="selectedAudio?.id === audio.id"
             [class.linked]="audio.linkedMediaId"
             (click)="selectAudio(audio)">
          <div class="media-thumb">
            <img *ngIf="audio.thumbnailUrl" [src]="audio.thumbnailUrl" alt="Audio thumbnail" />
            <i *ngIf="!audio.thumbnailUrl" class="pi pi-music"></i>
          </div>
          <div class="media-info">
            <div class="media-title">{{audio.title}}</div>
            <div class="media-artist">{{audio.artist?.name || 'Unknown Artist'}}</div>
            <div class="link-status" *ngIf="audio.linkedMediaId">
              <i class="pi pi-link"></i>
              <span>Linked to video</span>
            </div>
          </div>
          <div class="media-badge">
            <p-tag value="AUDIO" severity="info"></p-tag>
            <i *ngIf="audio.linkedMediaId" class="pi pi-check-circle linked-icon"></i>
          </div>
        </div>

        <div *ngIf="filteredAudioList.length === 0" class="empty-state">
          <i class="pi pi-inbox"></i>
          <p>No audio tracks found</p>
        </div>
      </div>

      <div *ngIf="isLoadingAudio" class="loading-state">
        <p-progressSpinner strokeWidth="4"></p-progressSpinner>
        <p>Loading audio...</p>
      </div>
    </div>

    <!-- Center - Connection Display -->
    <div class="connection-panel">
      <div class="connection-visual" *ngIf="selectedAudio">
        <!-- Selected Audio Card -->
        <div class="selected-media-card audio-card">
          <div class="card-thumb">
            <img *ngIf="selectedAudio.thumbnailUrl" [src]="selectedAudio.thumbnailUrl" alt="Audio" />
            <i *ngIf="!selectedAudio.thumbnailUrl" class="pi pi-music"></i>
          </div>
          <div class="card-info">
            <p-tag value="AUDIO" severity="info" class="mb-2"></p-tag>
            <div class="card-title">{{selectedAudio.title}}</div>
            <div class="card-artist">{{selectedAudio.artist?.name || 'Unknown Artist'}}</div>
          </div>
        </div>

        <!-- Connection Line -->
        <div class="connection-line" [class.connected]="selectedAudio.linkedMediaId">
          <svg viewBox="0 0 100 40" preserveAspectRatio="none">
            <path d="M0,20 C30,20 70,20 100,20" class="line-path"></path>
          </svg>
          <div class="connection-icon">
            <i class="pi" [ngClass]="selectedAudio.linkedMediaId ? 'pi-link' : 'pi-question-circle'"></i>
          </div>
        </div>

        <!-- Linked Video Card or Empty State -->
        <div class="selected-media-card video-card" *ngIf="selectedAudio.linkedMedia || getLinkedVideo(selectedAudio)">
          <div class="card-thumb">
            <img *ngIf="(selectedAudio.linkedMedia || getLinkedVideo(selectedAudio))?.thumbnailUrl"
                 [src]="(selectedAudio.linkedMedia || getLinkedVideo(selectedAudio))?.thumbnailUrl" alt="Video" />
            <i *ngIf="!(selectedAudio.linkedMedia || getLinkedVideo(selectedAudio))?.thumbnailUrl" class="pi pi-video"></i>
          </div>
          <div class="card-info">
            <p-tag value="VIDEO" severity="warning" class="mb-2"></p-tag>
            <div class="card-title">{{(selectedAudio.linkedMedia || getLinkedVideo(selectedAudio))?.title}}</div>
            <div class="card-artist">{{(selectedAudio.linkedMedia || getLinkedVideo(selectedAudio))?.artist?.name || 'Unknown Artist'}}</div>
          </div>
        </div>

        <div class="empty-video-card" *ngIf="!selectedAudio.linkedMediaId">
          <i class="pi pi-video"></i>
          <p>No video linked</p>
        </div>

        <!-- Action Buttons -->
        <div class="connection-actions">
          <p-button *ngIf="!selectedAudio.linkedMediaId"
                    label="Link to Video"
                    icon="pi pi-link"
                    (onClick)="openLinkDialog()"
                    styleClass="p-button-success">
          </p-button>
          <p-button *ngIf="selectedAudio.linkedMediaId"
                    label="Unlink"
                    icon="pi pi-unlink"
                    (onClick)="unlinkAudio(selectedAudio)"
                    [loading]="isLinking"
                    styleClass="p-button-danger p-button-outlined">
          </p-button>
          <p-button *ngIf="selectedAudio.linkedMediaId"
                    label="Change Link"
                    icon="pi pi-refresh"
                    (onClick)="openLinkDialog()"
                    styleClass="p-button-outlined">
          </p-button>
        </div>
      </div>

      <div class="no-selection" *ngIf="!selectedAudio">
        <i class="pi pi-arrow-left"></i>
        <p>Select an audio track to view or manage its video link</p>
      </div>
    </div>

    <!-- Right Panel - Video List -->
    <div class="media-panel video-panel">
      <div class="panel-header">
        <h3><i class="pi pi-video"></i> Video Tracks</h3>
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText [(ngModel)]="videoSearchQuery" (ngModelChange)="onVideoSearch()"
                 placeholder="Search video..." class="search-input" />
        </span>
      </div>

      <div class="media-list" *ngIf="!isLoadingVideo">
        <div *ngFor="let video of filteredVideoList"
             class="media-card"
             [class.selected]="selectedVideo?.id === video.id"
             [class.has-link]="getLinkedAudio(video)"
             (click)="selectVideo(video)">
          <div class="media-thumb">
            <img *ngIf="video.thumbnailUrl" [src]="video.thumbnailUrl" alt="Video thumbnail" />
            <i *ngIf="!video.thumbnailUrl" class="pi pi-video"></i>
          </div>
          <div class="media-info">
            <div class="media-title">{{video.title}}</div>
            <div class="media-artist">{{video.artist?.name || 'Unknown Artist'}}</div>
            <div class="link-status" *ngIf="getLinkedAudio(video)">
              <i class="pi pi-link"></i>
              <span>Has linked audio</span>
            </div>
          </div>
          <div class="media-badge">
            <p-tag value="VIDEO" severity="warning"></p-tag>
            <i *ngIf="getLinkedAudio(video)" class="pi pi-check-circle linked-icon"></i>
          </div>
        </div>

        <div *ngIf="filteredVideoList.length === 0" class="empty-state">
          <i class="pi pi-inbox"></i>
          <p>No video tracks found</p>
        </div>
      </div>

      <div *ngIf="isLoadingVideo" class="loading-state">
        <p-progressSpinner strokeWidth="4"></p-progressSpinner>
        <p>Loading videos...</p>
      </div>
    </div>
  </div>
</div>

<!-- Link Dialog -->
<p-dialog [(visible)]="showLinkDialog" header="Select Video to Link" [modal]="true" [style]="{width: '500px'}">
  <div class="link-dialog-content">
    <div class="selected-audio-info" *ngIf="selectedAudio">
      <p class="mb-2">Linking audio:</p>
      <div class="mini-card">
        <img *ngIf="selectedAudio.thumbnailUrl" [src]="selectedAudio.thumbnailUrl" alt="Audio" class="mini-thumb" />
        <i *ngIf="!selectedAudio.thumbnailUrl" class="pi pi-music mini-icon"></i>
        <div class="mini-info">
          <strong>{{selectedAudio.title}}</strong>
          <span>{{selectedAudio.artist?.name || 'Unknown Artist'}}</span>
        </div>
      </div>
    </div>

    <p-divider></p-divider>

    <div class="video-selection">
      <label class="block mb-2">Select video to link:</label>
      <p-dropdown [options]="videoList"
                  [(ngModel)]="selectedVideo"
                  optionLabel="title"
                  placeholder="Choose a video..."
                  [filter]="true"
                  filterBy="title"
                  [showClear]="true"
                  [style]="{width: '100%'}">
        <ng-template let-video pTemplate="item">
          <div class="dropdown-item">
            <img *ngIf="video.thumbnailUrl" [src]="video.thumbnailUrl" alt="thumb" class="dropdown-thumb" />
            <i *ngIf="!video.thumbnailUrl" class="pi pi-video dropdown-icon"></i>
            <div class="dropdown-info">
              <div class="dropdown-title">{{video.title}}</div>
              <div class="dropdown-artist">{{video.artist?.name || 'Unknown Artist'}}</div>
            </div>
          </div>
        </ng-template>
      </p-dropdown>
    </div>

    <div class="selected-video-preview" *ngIf="selectedVideo">
      <p class="mt-3 mb-2">Will link to:</p>
      <div class="mini-card video">
        <img *ngIf="selectedVideo.thumbnailUrl" [src]="selectedVideo.thumbnailUrl" alt="Video" class="mini-thumb" />
        <i *ngIf="!selectedVideo.thumbnailUrl" class="pi pi-video mini-icon"></i>
        <div class="mini-info">
          <strong>{{selectedVideo.title}}</strong>
          <span>{{selectedVideo.artist?.name || 'Unknown Artist'}}</span>
        </div>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancel" icon="pi pi-times" (onClick)="closeLinkDialog()" styleClass="p-button-text"></p-button>
    <p-button label="Link" icon="pi pi-link" (onClick)="linkMedia()" [disabled]="!selectedVideo" [loading]="isLinking" styleClass="p-button-success"></p-button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
