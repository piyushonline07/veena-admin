<div class="media-list-container">
    <div class="header-section mb-4 flex justify-content-between align-items-center">
        <div>
            <h1>Manage Media</h1>
            <p class="text-secondary">View and manage all uploaded video and audio content.</p>
        </div>
        <div class="flex align-items-center gap-3">
            <p-selectButton
                [options]="[{label: 'List', value: 'list', icon: 'pi pi-list'}, {label: 'Grid', value: 'grid', icon: 'pi pi-th-large'}]"
                [(ngModel)]="viewMode" optionLabel="label" optionValue="value" styleClass="mode-toggle">
                <ng-template let-item>
                    <i [class]="item.icon" pTooltip="{{item.label}}"></i>
                </ng-template>
            </p-selectButton>

            <div class="search-container">
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input type="text" pInputText placeholder="Search by title..." [(ngModel)]="searchQuery"
                        (input)="onSearch()" class="p-inputtext-sm w-20rem" />
                </span>
            </div>
        </div>
    </div>

    <div *ngIf="viewMode === 'list'">
        <p-card>
            <p-table [value]="mediaList" [lazy]="true" (onLazyLoad)="onPageChange($event)" [paginator]="true"
                [rows]="rows" [totalRecords]="totalRecords" [loading]="loading" [showCurrentPageReport]="true"
                styleClass="p-datatable-striped"
                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries">

                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 80px">Thumbnail</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Visibility</th>
                        <th>Created At</th>
                        <th style="width: 150px">Actions</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-media>
                    <tr>
                        <td (click)="previewMedia(media)" class="cursor-pointer">
                            <img [src]="media.thumbnailKey ? ('https://d1zz20p5id8x5j.cloudfront.net/' + media.thumbnailKey) : 'assets/placeholder-thumb.png'"
                                [alt]="media.title" width="60" class="shadow-2 border-round" />
                        </td>
                        <td>
                            <span class="font-bold text-lg cursor-pointer"
                                (click)="previewMedia(media)">{{media.title}}</span>
                            <div class="text-xs text-secondary">{{media.id}}</div>
                        </td>
                        <td>
                            <p-tag [value]="media.mediaType"
                                [severity]="media.mediaType === 'VIDEO' ? 'primary' : 'info'"></p-tag>
                        </td>
                        <td>
                            <p-tag [value]="media.status"
                                [severity]="media.status === 'READY' ? 'success' : 'warning'"></p-tag>
                        </td>
                        <td>
                            <p-tag [value]="media.visibility"
                                [severity]="media.visibility === 'PUBLIC' ? 'success' : 'danger'"></p-tag>
                        </td>
                        <td>{{media.createdAt | date:'short'}}</td>
                        <td>
                            <div class="flex gap-2">
                                <button pButton icon="pi pi-play"
                                    class="p-button-rounded p-button-text p-button-success"
                                    (click)="previewMedia(media)" [disabled]="media.status !== 'READY'"
                                    pTooltip="Preview"></button>
                                <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text"
                                    (click)="editMedia(media)" pTooltip="Edit"></button>
                                <button pButton icon="pi pi-trash"
                                    class="p-button-rounded p-button-text p-button-danger" (click)="deleteMedia(media)"
                                    pTooltip="Delete"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7">No media items found.</td>
                    </tr>
                </ng-template>
            </p-table>
        </p-card>
    </div>

    <!-- Grid / Gallery View -->
    <div *ngIf="viewMode === 'grid'">
        <div class="media-grid" *ngIf="!loading && mediaList.length > 0">
            <div *ngFor="let media of mediaList" class="media-card" (click)="previewMedia(media)">
                <div class="thumbnail-container">
                    <img [src]="media.thumbnailKey ? ('https://d1zz20p5id8x5j.cloudfront.net/' + media.thumbnailKey) : 'assets/placeholder-thumb.png'"
                        [alt]="media.title">
                    <div class="card-overlay" *ngIf="media.status === 'READY'">
                        <i class="pi pi-play-circle" *ngIf="media.mediaType === 'VIDEO'"></i>
                        <i class="pi pi-volume-up" *ngIf="media.mediaType === 'AUDIO'"></i>
                    </div>
                    <p-tag [value]="media.mediaType" [severity]="media.mediaType === 'VIDEO' ? 'primary' : 'info'"
                        class="media-type-badge"></p-tag>
                    <div class="duration-badge" *ngIf="media.durationSeconds">{{media.durationSeconds |
                        number:'1.0-0'}}s</div>
                </div>
                <div class="card-content">
                    <div class="media-title" [title]="media.title">{{media.title}}</div>
                    <div class="media-description">{{media.description || 'No description available.'}}</div>
                    <div class="card-footer">
                        <p-tag [value]="media.status"
                            [severity]="media.status === 'READY' ? 'success' : 'warning'"></p-tag>
                        <div class="flex gap-1" (click)="$event.stopPropagation()">
                            <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-sm"
                                (click)="editMedia(media)"></button>
                            <button pButton icon="pi pi-trash"
                                class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                (click)="deleteMedia(media)"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div *ngIf="loading" class="flex justify-content-center p-8">
            <p-progressSpinner></p-progressSpinner>
        </div>

        <div *ngIf="!loading && mediaList.length === 0" class="flex justify-content-center p-8">
            <div class="text-center">
                <i class="pi pi-inbox text-5xl text-secondary mb-4"></i>
                <div class="text-xl">No media items found.</div>
            </div>
        </div>

        <p-paginator [rows]="rows" [totalRecords]="totalRecords" [first]="first" (onPageChange)="onPageChange($event)"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"></p-paginator>
    </div>
</div>

<!-- Edit Dialog -->
<p-dialog [(visible)]="mediaDialog" [style]="{width: '450px'}" header="Media Details" [modal]="true" class="p-fluid">
    <ng-template pTemplate="content">
        <div class="field mb-4">
            <label for="title" class="block font-bold mb-2">Title</label>
            <input type="text" pInputText id="title" [(ngModel)]="selectedMedia.title" required autofocus
                class="w-full" />
        </div>
        <div class="field mb-4">
            <label for="description" class="block font-bold mb-2">Description</label>
            <textarea id="description" pInputTextarea [(ngModel)]="selectedMedia.description" required rows="3"
                cols="20" class="w-full"></textarea>
        </div>
        <div class="field mb-4">
            <label for="visibility" class="block font-bold mb-2">Visibility</label>
            <p-dropdown [options]="visibilityOptions" [(ngModel)]="selectedMedia.visibility" optionLabel="label"
                optionValue="value" class="w-full" id="visibility">
            </p-dropdown>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton label="Save" icon="pi pi-check" class="p-button-text" (click)="saveMedia()"></button>
    </ng-template>
</p-dialog>

<!-- Preview Dialog -->
<p-dialog [(visible)]="previewDialog" [style]="{width: '800px'}" [header]="selectedMediaForPreview?.title"
    [modal]="true" class="p-fluid" (onHide)="closePreview()">

    <div *ngIf="previewDialog && selectedMediaForPreview">
        <app-hls-player [url]="selectedMediaForPreview.hlsUrl"
            [posterUrl]="selectedMediaForPreview.thumbnailKey ? ('https://d1zz20p5id8x5j.cloudfront.net/' + selectedMediaForPreview.thumbnailKey) : ''"
            [mediaType]="selectedMediaForPreview.mediaType" maxHeight="500px">
        </app-hls-player>
    </div>

    <div class="mt-3" *ngIf="selectedMediaForPreview">
        <div class="text-xl font-bold mb-2">{{selectedMediaForPreview.title}}</div>
        <p class="text-secondary line-height-3">{{selectedMediaForPreview.description}}</p>
        <div class="flex gap-2 mt-2">
            <p-tag [value]="selectedMediaForPreview.mediaType" severity="info"></p-tag>
            <p-tag [value]="selectedMediaForPreview.visibility"
                [severity]="selectedMediaForPreview.visibility === 'PUBLIC' ? 'success' : 'danger'"></p-tag>
        </div>
    </div>
</p-dialog>

<p-toast></p-toast>