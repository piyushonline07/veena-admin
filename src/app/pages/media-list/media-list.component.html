<div class="media-list-container">
    <div class="header-section mb-4">
        <div class="header-title">
            <h1>Manage Media</h1>
            <p class="text-secondary hide-mobile">View and manage all uploaded video and audio content.</p>
        </div>
        <div class="header-actions">
            <p-selectButton
                [options]="[{label: 'List', value: 'list', icon: 'pi pi-list'}, {label: 'Grid', value: 'grid', icon: 'pi pi-th-large'}]"
                [(ngModel)]="viewMode" optionLabel="label" optionValue="value" styleClass="mode-toggle">
                <ng-template let-item>
                    <i [class]="item.icon" pTooltip="{{item.label}}"></i>
                </ng-template>
            </p-selectButton>

            <div class="search-container">
                <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input type="text" pInputText placeholder="Search..." [(ngModel)]="searchQuery"
                        (input)="onSearch()" class="p-inputtext-sm search-input" />
                </span>
            </div>
        </div>
    </div>

    <div *ngIf="viewMode === 'list'" class="table-section">
        <p-card>
            <div class="table-wrapper">
                <p-table [value]="mediaList" [lazy]="true" (onLazyLoad)="onPageChange($event)" [paginator]="true"
                    [rows]="rows" [totalRecords]="totalRecords" [loading]="loading" [showCurrentPageReport]="true"
                    styleClass="p-datatable-striped p-datatable-sm"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                    [scrollable]="true" [responsive]="true">

                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 70px; min-width: 70px;">Thumb</th>
                        <th style="width: 150px; min-width: 120px;">Title</th>
                        <th style="width: 100px; min-width: 80px;" class="hide-mobile">Artist</th>
                        <th style="width: 100px; min-width: 80px;" class="hide-tablet">Album</th>
                        <th style="width: 70px; min-width: 60px;">Type</th>
                        <th style="width: 70px; min-width: 60px;" class="hide-mobile">Status</th>
                        <th style="width: 80px; min-width: 70px;" class="hide-tablet">Visibility</th>
                        <th style="width: 90px; min-width: 80px;" class="hide-tablet">Created</th>
                        <th style="width: 100px; min-width: 90px;">Actions</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-media>
                    <tr>
                        <td (click)="previewMedia(media)" class="cursor-pointer">
                            <div class="thumbnail-cell">
                                <img [src]="media.thumbnailUrl || 'assets/placeholder-thumb.png'" [alt]="media.title"
                                    width="60" class="shadow-2 border-round" />
                                <i *ngIf="media.linkedMediaId" class="pi pi-link link-indicator"
                                   pTooltip="Has linked media"></i>
                            </div>
                        </td>
                        <td class="title-cell">
                            <div class="title-wrapper">
                                <span class="media-title font-bold cursor-pointer"
                                    (click)="previewMedia(media)"
                                    [pTooltip]="media.title"
                                    tooltipPosition="top"
                                    [tooltipDisabled]="media.title?.length < 25">{{media.title}}</span>
                                <div class="media-id text-xs text-secondary"
                                     [pTooltip]="media.id"
                                     tooltipPosition="bottom">{{media.id}}</div>
                            </div>
                        </td>
                        <td class="hide-mobile">
                            <div *ngIf="media.artist" class="artist-cell">
                                <span class="artist-name"
                                      [pTooltip]="media.artist.name"
                                      tooltipPosition="top"
                                      [tooltipDisabled]="media.artist.name?.length < 15">{{media.artist.name}}</span>
                                <i *ngIf="media.artist.verified" class="pi pi-verified verified-icon"
                                    pTooltip="Verified Artist"></i>
                            </div>
                            <span *ngIf="!media.artist" class="text-secondary">-</span>
                        </td>
                        <td class="hide-tablet">
                            <div *ngIf="media.album" class="album-cell">
                                <i class="pi pi-book text-secondary text-sm hide-mobile"></i>
                                <span class="album-name"
                                      [pTooltip]="media.album.name"
                                      tooltipPosition="top"
                                      [tooltipDisabled]="media.album.name?.length < 15">{{media.album.name}}</span>
                            </div>
                            <span *ngIf="!media.album" class="text-secondary">-</span>
                        </td>
                        <td class="type-cell">
                            <p-tag [value]="media.mediaType"
                                [severity]="media.mediaType === 'VIDEO' ? 'primary' : 'info'"
                                styleClass="type-tag"></p-tag>
                        </td>
                        <td class="hide-mobile">
                            <p-tag [value]="media.status"
                                [severity]="media.status === 'READY' ? 'success' : 'warning'"
                                styleClass="status-tag"></p-tag>
                        </td>
                        <td class="hide-tablet">
                            <p-tag [value]="media.visibility"
                                [severity]="media.visibility === 'PUBLIC' ? 'success' : 'danger'"
                                styleClass="visibility-tag"></p-tag>
                        </td>
                        <td class="hide-tablet">{{media.createdAt | date:'shortDate'}}</td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <button pButton icon="pi pi-play"
                                    class="p-button-rounded p-button-text p-button-success p-button-sm"
                                    (click)="previewMedia(media)" [disabled]="media.status !== 'READY'"
                                    pTooltip="Preview"></button>
                                <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-sm"
                                    (click)="editMedia(media)" pTooltip="Edit"></button>
                                <button pButton icon="pi pi-trash"
                                    class="p-button-rounded p-button-text p-button-danger p-button-sm" (click)="deleteMedia(media)"
                                    pTooltip="Delete"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="9">No media items found.</td>
                    </tr>
                </ng-template>
            </p-table>
            </div>
        </p-card>
    </div>

    <!-- Grid / Gallery View -->
    <div *ngIf="viewMode === 'grid'">
        <div class="media-grid" *ngIf="!loading && mediaList.length > 0">
            <div *ngFor="let media of mediaList" class="media-card" (click)="previewMedia(media)">
                <div class="thumbnail-container">
                    <img [src]="media.thumbnailUrl || 'assets/placeholder-thumb.png'" [alt]="media.title">
                    <div class="card-overlay" *ngIf="media.status === 'READY'">
                        <i class="pi pi-play-circle" *ngIf="media.mediaType === 'VIDEO'"></i>
                        <i class="pi pi-volume-up" *ngIf="media.mediaType === 'AUDIO'"></i>
                    </div>
                    <p-tag [value]="media.mediaType" [severity]="media.mediaType === 'VIDEO' ? 'primary' : 'info'"
                        class="media-type-badge"></p-tag>
                    <div class="duration-badge" *ngIf="media.durationSeconds">{{media.durationSeconds |
                        number:'1.0-0'}}s</div>
                </div>
                <div class="card-content">
                    <div class="media-title"
                         [pTooltip]="media.title"
                         tooltipPosition="top"
                         [tooltipDisabled]="media.title?.length < 30">{{media.title}}</div>
                    <div class="media-description"
                         [pTooltip]="media.description"
                         tooltipPosition="bottom"
                         [tooltipDisabled]="!media.description || media.description?.length < 50">{{media.description || 'No description available.'}}</div>
                    <div class="card-footer">
                        <p-tag [value]="media.status"
                            [severity]="media.status === 'READY' ? 'success' : 'warning'"></p-tag>
                        <div class="flex gap-1" (click)="$event.stopPropagation()">
                            <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-sm"
                                (click)="editMedia(media)" pTooltip="Edit"></button>
                            <button pButton icon="pi pi-trash"
                                class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                (click)="deleteMedia(media)" pTooltip="Delete"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div *ngIf="loading" class="flex justify-content-center p-8">
            <p-progressSpinner></p-progressSpinner>
        </div>

        <div *ngIf="!loading && mediaList.length === 0" class="flex justify-content-center p-8">
            <div class="text-center">
                <i class="pi pi-inbox text-5xl text-secondary mb-4"></i>
                <div class="text-xl">No media items found.</div>
            </div>
        </div>

        <p-paginator [rows]="rows" [totalRecords]="totalRecords" [first]="first" (onPageChange)="onPageChange($event)"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"></p-paginator>
    </div>
</div>

<!-- Edit Dialog -->
<p-dialog [(visible)]="mediaDialog" [style]="{width: '450px'}" header="Media Details" [modal]="true" class="p-fluid">
    <ng-template pTemplate="content">
        <div class="field mb-4">
            <label for="title" class="block font-bold mb-2">Title</label>
            <input type="text" pInputText id="title" [(ngModel)]="selectedMedia.title" required autofocus
                class="w-full" />
        </div>
        <div class="field mb-4">
            <label for="description" class="block font-bold mb-2">Description</label>
            <textarea id="description" pInputTextarea [(ngModel)]="selectedMedia.description" required rows="3"
                cols="20" class="w-full"></textarea>
        </div>
        <div class="field mb-4">
            <label for="visibility" class="block font-bold mb-2">Visibility</label>
            <p-dropdown [options]="visibilityOptions" [(ngModel)]="selectedMedia.visibility" optionLabel="label"
                optionValue="value" class="w-full" id="visibility">
            </p-dropdown>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton label="Save" icon="pi pi-check" class="p-button-text" (click)="saveMedia()"></button>
    </ng-template>
</p-dialog>

<!-- Preview Dialog -->
<p-dialog [(visible)]="previewDialog" [style]="{width: '900px'}" [header]="selectedMediaForPreview?.title"
    [modal]="true" class="p-fluid media-preview-dialog" (onHide)="closePreview()">

    <div *ngIf="previewDialog && selectedMediaForPreview" class="preview-content">
        <!-- Video Preview -->
        <div *ngIf="selectedMediaForPreview.mediaType === 'VIDEO'" class="video-preview">
            <app-hls-player [url]="selectedMediaForPreview.hlsUrl"
                [posterUrl]="selectedMediaForPreview.thumbnailUrl || ''" [mediaType]="selectedMediaForPreview.mediaType"
                maxHeight="500px">
            </app-hls-player>
        </div>

        <!-- Audio Preview with Prominent Thumbnail -->
        <div *ngIf="selectedMediaForPreview.mediaType === 'AUDIO'" class="audio-preview">
            <app-hls-audio-player
                [url]="selectedMediaForPreview.hlsUrl"
                [posterUrl]="selectedMediaForPreview.thumbnailUrl || ''"
                [lyricsUrl]="selectedMediaForPreview.lyricsUrl || ''">
            </app-hls-audio-player>
        </div>

        <!-- Media Info Section -->
        <div class="media-info-section mt-4 p-3 surface-card border-round">
            <div class="flex align-items-start gap-3">
                <div class="flex-grow-1">
                    <h3 class="m-0 mb-2">{{selectedMediaForPreview.title}}</h3>
                    <p class="text-secondary m-0 line-height-3">{{selectedMediaForPreview.description || 'No description available.'}}</p>
                </div>
            </div>

            <div class="flex flex-wrap align-items-center gap-2 mt-3">
                <p-tag [value]="selectedMediaForPreview.mediaType"
                       [severity]="selectedMediaForPreview.mediaType === 'VIDEO' ? 'primary' : 'info'">
                </p-tag>
                <p-tag [value]="selectedMediaForPreview.visibility"
                       [severity]="selectedMediaForPreview.visibility === 'PUBLIC' ? 'success' : 'danger'">
                </p-tag>
                <p-tag *ngIf="selectedMediaForPreview.artist"
                       [value]="selectedMediaForPreview.artist.name"
                       severity="secondary">
                </p-tag>
                <p-tag *ngIf="selectedMediaForPreview.album"
                       [value]="selectedMediaForPreview.album.name"
                       severity="warning"
                       icon="pi pi-book">
                </p-tag>
            </div>

            <!-- Linked Media Section -->
            <div *ngIf="selectedMediaForPreview.linkedMedia" class="linked-media-section mt-3 p-3 surface-ground border-round">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-link text-primary"></i>
                    <span class="font-semibold">Linked {{selectedMediaForPreview.linkedMedia.mediaType}}</span>
                </div>
                <div class="flex align-items-center gap-3">
                    <img *ngIf="selectedMediaForPreview.linkedMedia.thumbnailUrl"
                         [src]="selectedMediaForPreview.linkedMedia.thumbnailUrl"
                         alt="Linked media thumbnail"
                         class="linked-thumbnail border-round" />
                    <div>
                        <div class="font-medium">{{selectedMediaForPreview.linkedMedia.title}}</div>
                        <p-tag [value]="selectedMediaForPreview.linkedMedia.mediaType"
                               [severity]="selectedMediaForPreview.linkedMedia.mediaType === 'VIDEO' ? 'primary' : 'info'"
                               class="mt-1">
                        </p-tag>
                    </div>
                </div>
            </div>

            <div class="flex align-items-center gap-2 mt-3">
                <a *ngIf="selectedMediaForPreview.lyricsUrl"
                   [href]="selectedMediaForPreview.lyricsUrl" target="_blank"
                   pButton icon="pi pi-file" label="View Lyrics"
                   class="p-button-sm p-button-outlined"></a>
            </div>
        </div>
    </div>
</p-dialog>

<p-toast></p-toast>
